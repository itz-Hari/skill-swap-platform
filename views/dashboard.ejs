<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard - Skill Swap</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/home">Skill Swap</a>

        <div class="dropdown ms-auto">
          <a
            class="text-white dropdown-toggle text-decoration-none"
            data-bs-toggle="dropdown"
          >
            <%= user.name %>
          </a>

          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="/profile/<%= user.id %>"
                >My Profile</a
              >
            </li>
            <li><a class="dropdown-item" href="/dashboard">Dashboard</a></li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a class="dropdown-item text-danger" href="/logout">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <% if (success) { %>
    <div class="alert alert-success"><%= success %></div>
    <% } %> <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <div class="container my-5">
      <input
        type="text"
        id="searchInput"
        class="form-control mb-4"
        placeholder="Search by name..."
        onkeyup="filterRequests()"
      />
      <!-- ================= INCOMING ================= -->
      <h3>Incoming Requests</h3>

      <% if (!incoming || incoming.length === 0) { %>
      <p class="text-muted">No incoming requests.</p>
      <% } else { %> <% incoming.forEach(r => { %>
      <div
        class="card mb-3 shadow-sm request-card"
        data-name="<%= r.sender_name.toLowerCase() %>"
      >
        <div class="card-body">
          <% if (r.message) { %>
          <p class="text-muted mt-2">
            <strong>Message:</strong> <%= r.message %>
          </p>
          <% } %>
          <h5 class="d-flex align-items-center gap-2">
            <%= r.sender_name %>

            <a
              href="/profile/<%= r.sender_id %>"
              class="btn btn-outline-primary btn-sm"
            >
              View Profile
            </a>
          </h5>

          <p>
            <strong>Offers:</strong> <%= r.skill_offer %> |
            <strong>Wants:</strong> <%= r.skill_need %>
          </p>

          <span class="badge bg-warning">pending</span>

          <div class="mt-3 d-flex gap-2">
            <form method="POST" action="/dashboard/accept/<%= r.id %>">
              <button class="btn btn-success btn-sm">Accept</button>
            </form>

            <form method="POST" action="/dashboard/reject/<%= r.id %>">
              <button class="btn btn-danger btn-sm">Reject</button>
            </form>
          </div>
        </div>
      </div>
      <% }) %> <% } %>

      <hr class="my-5" />

      <!-- ================= SENT ================= -->
      <h3>My Sent Requests</h3>

      <% if (!outgoing || outgoing.length === 0) { %>
      <p class="text-muted">No sent requests.</p>
      <% } else { %> <% outgoing.forEach(r => { %>
      <div
        class="card mb-3 shadow-sm request-card"
        data-name="<%= r.receiver_name.toLowerCase() %>"
      >
        <div class="card-body">
          <% if (r.message) { %>
          <p class="text-muted mt-2">
            <strong>Message:</strong> <%= r.message %>
          </p>
          <% } %>
          <p>
            <strong>To:</strong> <%= r.receiver_name %><br />
            <strong>Offers:</strong> <%= r.skill_offer %> |
            <strong>Wants:</strong> <%= r.skill_need %>
          </p>

          <span class="badge bg-warning">pending</span>
        </div>
      </div>
      <% }) %> <% } %>

      <hr class="my-5" />

      <!-- ================= ARCHIVED ================= -->
      <h3>Archived Requests</h3>

      <% if (!archived || archived.length === 0) { %>
      <p class="text-muted">No archived requests.</p>
      <% } else { %> <% archived.forEach(r => { %>
      <div
        class="card mb-3 shadow-sm request-card"
        data-name="<%= (r.sender_name + ' ' + r.receiver_name).toLowerCase() %>"
      >
        <div class="card-body">
          <p>
            <strong><%= r.sender_name %> â†’ <%= r.receiver_name %></strong><br />
            <strong>Offers:</strong> <%= r.skill_offer %> |
            <strong>Wants:</strong> <%= r.skill_need %>
          </p>

          <span
            class="badge <%= r.status === 'accepted' ? 'bg-success' : r.status === 'rejected' ? 'bg-danger' : 'bg-warning' %>"
          >
            <%= r.status %>
          </span>

          <% if (r.status === 'accepted') { %>
          <a href="/chat/<%= r.id %>" class="btn btn-primary btn-sm mt-2"
            >Open Chat</a
          >
          <% } %>
        </div>
      </div>
      <% }) %> <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function filterRequests() {
        const input = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const cards = document.querySelectorAll(".request-card");

        cards.forEach((card) => {
          const name = card.getAttribute("data-name");
          card.style.display = name.includes(input) ? "block" : "none";
        });
      }
    </script>
  </body>
</html>
