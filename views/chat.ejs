<!DOCTYPE html>
<html>
  <head>
    <title>Skill Swap Chat</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      .chat-row {
        display: flex;
        margin-bottom: 8px;
      }

      .chat-you {
        margin-right: auto;
        background: #e2e3e5;
        padding: 8px 12px;
        border-radius: 10px;
        max-width: 60%;
      }

      .chat-them {
        margin-left: auto;
        background: #0d6efd;
        color: white;
        padding: 8px 12px;
        border-radius: 10px;
        max-width: 60%;
      }

      .chat-label {
        font-size: 12px;
        font-weight: bold;
        opacity: 0.7;
      }
    </style>
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/dashboard">â¬… Back to Dashboard</a>
        <span class="text-white">Chat with Skill Partner</span>
      </div>
    </nav>

    <div class="container my-4">
      <div
        id="chatBox"
        class="border rounded p-3 bg-white"
        style="height: 300px; overflow-y: auto"
      >
        <% messages.forEach(m => { %>
        <div class="chat-row">
          <% if (m.sender_id === user.id) { %>
          <div class="chat-you">
            <div class="chat-label">You</div>
            <%= m.message %>
          </div>
          <% } else { %>
          <div class="chat-them">
            <div class="chat-label">Them</div>
            <%= m.message %>
          </div>
          <% } %>
        </div>
        <% }) %>
      </div>

      <form id="chatForm" class="mt-3">
        <input
          type="text"
          id="messageInput"
          class="form-control"
          placeholder="Type a message..."
          required
        />
      </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
      const socket = io();

      const ROOM_ID = "<%= requestId %>";
      const CURRENT_USER_ID = <%= user.id %>;

      socket.emit("joinRoom", ROOM_ID);

      const chatBox = document.getElementById("chatBox");
      const form = document.getElementById("chatForm");
      const input = document.getElementById("messageInput");

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const msg = input.value.trim();
        if (!msg) return;

        socket.emit("sendMessage", {
          roomId: ROOM_ID,
          sender_id: CURRENT_USER_ID,
          message: msg
        });

        fetch("/chat/send", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `request_id=${ROOM_ID}&message=${encodeURIComponent(msg)}`
        });

        input.value = "";
      });

      socket.on("receiveMessage", (data) => {
        const row = document.createElement("div");
        row.className = "chat-row";

        const bubble = document.createElement("div");

        if (data.sender_id === CURRENT_USER_ID) {
          bubble.className = "chat-you";
          bubble.innerHTML = `<div class="chat-label">You</div>${data.message}`;
        } else {
          bubble.className = "chat-them";
          bubble.innerHTML = `<div class="chat-label">Them</div>${data.message}`;
        }

        row.appendChild(bubble);
        chatBox.appendChild(row);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    </script>
  </body>
</html>
