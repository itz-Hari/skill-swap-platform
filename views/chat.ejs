<!DOCTYPE html>
<html>
  <head>
    <title>Chat</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/dashboard">â¬… Back to Dashboard</a>
      </div>
    </nav>

    <div class="container my-4">
      <h4 class="mb-3">Skill Swap Chat</h4>

      <div
        class="border rounded p-3 mb-3 bg-white"
        id="chatBox"
        style="height: 300px; overflow-y: auto"
      >
        <% if (messages.length === 0) { %>
        <p class="text-muted">No messages yet. Start the conversation ðŸ‘‹</p>
        <% } else { %> <% messages.forEach(m => { %>
        <p>
          <strong><%= m.sender_id === user.id ? "You" : "Them" %>:</strong>
          <%= m.message %>
        </p>
        <% }) %> <% } %>
      </div>

      <form id="chatForm">
        <input
          type="text"
          id="messageInput"
          class="form-control"
          placeholder="Type message..."
          required
        />
      </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const roomId = "<%= requestId %>";
      const userId = Number("<%= user.id %>");

      socket.emit("joinRoom", roomId);

      const chatBox = document.getElementById("chatBox");
      const form = document.getElementById("chatForm");
      const input = document.getElementById("messageInput");

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const msg = input.value.trim();
        if (!msg) return;

        socket.emit("sendMessage", {
          roomId,
          sender_id: userId,
          message: msg,
        });

        fetch("/chat/send", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `request_id=${roomId}&message=${encodeURIComponent(msg)}`,
        });

        input.value = "";
      });

      socket.on("receiveMessage", (data) => {
        const p = document.createElement("p");
        p.innerHTML =
          "<strong>" +
          (Number(data.sender_id) === userId ? "You" : "Them") +
          ":</strong> " +
          data.message;

        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    </script>
  </body>
</html>
